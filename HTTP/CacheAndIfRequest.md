## 캐시와 조건부 요청



### 1. 캐시 기본 동작

동작 원리: 클라이언트에서 요청한 데이터를 브라우저 캐시에 응답 결과를 저장한다. 이때 유효 시간을 갖는 것. 유효시간동안 재요청시 네트워크 연결 없이 데이터를 사용할 수 있는 것.

- 캐시가 없을 때
  - 데이터가 변경되지 않아도 계속 네트워크를 통해서 데이터를 다운로드 받아야 한다.
  - 인터넷 네트워크는 매우 느리고 비싸다.
  - 브라우저 로딩 속도가 느리다.
  - 느린 사용자 경험
- 캐시 적용
  - 캐시 덕분에 캐시 가능 시간동안 네트워크를 사용하지 않아도 된다.
  - 비싼 네트워크 사용량을 줄일 수 있다.
  - 브라우저 로딩 속도가 매우 빠르다.
  - 빠른 사용자 경험
- 캐시 시간 초과
  - 캐시 유효 시간이 초과하면, 서버를 통해 데이터를 다시 조회하고, 캐시를 갱신한다. 이때 다시 네트워크 다운로드가 발생



### 2. 검증 헤더와 조건부 요청

캐시 만료 후에도 서버에서 데이터를 변경하지 않아 저장한 캐시를 재사용할 수 있는데, 단 클라이언트의 데이터와 서버의 데이터가 같다는 사실을 확인할 방법이 필요하다 -> 검증헤더의 등장

- 만료 후 요청을 보낼 때 데이터 최종 수정(if-modified-since)일을 같이 보낸다. 이때 304 Not Modified와 Last-Modified를 보내며 바디를 빼서 보내준다. -> 변경된 것이 아니므로 캐시가 다시 유효한 정보가 된다.

- 캐시 유효 시간이 초과해도, 서버의 데이터가 갱신되지 않을 때
- 304 Not Modified + 헤더 메타 정보만 응답(바디 X)
- 클라이언트는 서버가 보낸 응답 헤더 정보로 캐시의 메타 정보를 갱신
- 클라이언트는 캐시에 저장되어 있는 데이터 재활용
- 네트워크 다운로드가 발생하지만 용량이 적은 헤더 정보만 다운 -> 실용적 해결책

- 검증 헤더: 캐시 데이터와 서버 데이터가 같은지 검증하는 데이터 (Last-Modified, ETag)
- 조건부 요청 헤더
  - 검증 헤더로 조건에 따른 분기
  - if-Modified-Since: Last-Modified 사용
  - if-None-Match: ETag 사용
  - 조건이 만족하면 200 OK -> 데이터 수정
  - 조건이 만족하지 않으면 304 Not Modified(캐시로 리다이렉션) -> 데이터 미변경
- Last-Modified, If-Modified-Since 단점
  - 1초 미만 단위로 캐시 조정이 불가능
  - 날짜 기반의 로직 사용
  - 데이터를 수정해서 날짜가 다르지만, 같은 데이터를 수정해서 데이터 결과가 똑같은 경우
  - 서버에서 별도의 캐시 로직을 관리하고 싶은 경우
- ETag, If-None-Match
  - 캐시용 데이터에 임의의 고유한 버전 이름을 달아둔 것
  - 데이터가 변경되면 이 이름을 바꾸어서 변경
  - ETag만 보내서 같으면 유지, 다르면 다시 받기
  - 캐시 제어 로직을 서버에서 완전히 관리
  - 클라이언트는 단순히 이 값을 서버에 제공



### 3. 캐시와 조건부 요청 헤더

- Cache-Control(캐시 제어)
  - Max-age: 캐시 유효시간, 초 단위
  - No-cache: 데이터는 캐시해도 되지만, 항상 서버에 검증하고 사용
  - no-store: 데이터에 민감한 정보가 있으므로 저장하면 안된다.
- Pragma(캐시 제어 하위호환)
  - Pragma: no-cache, HTTP 1.0 하위 호환
- Expires(캐시 만료일 지정)
  - 캐시 만료일을 정확한 날짜로 지정
  - HTTP 1.0 부터 사용
  - 지금은 더 유연한 Cache-Control: max-age 권장
  - Max-age와 함께 사용하면 Expires는 무시



### 4. 프록시 캐시

- 해외 서버에 있는 정보를 내려 받을 때 중간에 거쳐서 받는 캐시 서버로 public 캐시를 이용해 미리 정보를 받아두고 웹 브라우저 private 캐시에 저장하는 원리

참고

- Cache-Control: public: 응답이 public 캐시에 저장되어도 됨
- Cache-Control: private: 응답이 해당 사용자만을 위한 것, private 캐시에 저장되어야 한다.
- Cache-Control: s-maxage: 프록시 캐시에만 적용되는 max-age
- Age: 60(HTTP 헤더): 오리진 서버에서 응답 후 프록시 캐시 내에 머문 시간



### 5. 캐시 무효화

확실한 캐시 무효화 응답

- Cache-Control: no-cache, no-store, must-revalidate
  - no-cache: 데이터는 캐시해도 되지만, 항상 원 서버에 검증하고 사용
  - no-store: 데이터에 민감한 정보가 있으므로 저장하면 안된다.
  - Must-revalidate: 캐시 만료후 최초 조회시 원 서버에 검증해야한다.
- Pragma: no-cache(HTTP 1.0 하위 호환)